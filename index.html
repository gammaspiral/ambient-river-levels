<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ambient River Levels</title>
<style>
      .leaflet-control-attribution {
        filter: invert(100%); 
      }
</style>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" 
      rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" 
      crossorigin="anonymous">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
crossorigin="">
</script>
</head>
<body>
  <div class="container">
    <div class="row">
      <div class="col">
        <h1 class="mt-5">Ambient River Levels</h1>
        <p>Continuously updated</p>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <button id="startButton" class="btn btn-primary mt-3">Start Music</button>
        <button id="stopButton" class="btn btn-danger mt-3">Stop Music</button>
      <p></p>
      <div id="map" style="width: 600px; height: 400px;"></div>
      </div>
    </div>
  </div>


<script src="https://cdn.jsdelivr.net/npm/tone@14"></script>
<script>
    // Data
    const csvURL = "https://raw.githubusercontent.com/gammaspiral/ambient-river-levels/main/Westminster.csv";

 // Initialize audio components
    let synth;
    let reverb;

    // Create an AudioContext within a user gesture (e.g., button click)
    document.getElementById('startButton').addEventListener('click', () => {
      // Create an AudioContext
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();

      // Initialize audio components within the user gesture event
      synth = new Tone.Synth().toDestination();
      reverb = new Tone.Reverb({
        decay: 1,
        wet: 1,
      }).connect(synth);

      // Start playing when the user clicks the "Start Music" button
      startMusic();
    });

    // Start playing music
    function startMusic() {
      let index = 0;
      const interval = 2000; // Simulated data update interval (2 seconds)

      function playNextNote() {
        // Use the data to control synth parameters (e.g., pitch and volume)
        const dataValue = parseFloat(csvData[index]['Height (m)']);
        const pitch = mapDataToPitch(dataValue);
        const volume = dataValue;

        // Play a note
        synth.triggerAttackRelease(pitch, '8n', undefined, volume);

        // Move to the next data point
        index = (index + 1) % csvData.length;

        // Schedule the next note
        setTimeout(playNextNote, interval);
      }

      // Start playing
      playNextNote();
    }

    // Stop button event
    document.getElementById('stopButton').addEventListener('click', () => {
      // Check if the synth object exists and is valid
      if (synth) {
        // Release all notes
        synth.triggerRelease();
      }
    });

    let csvData = [];
    let minDataValue;
    let maxDataValue;

    // Fetch CSV data from the URL
    fetch(csvURL)
      .then((response) => response.text())
      .then((data) => {
        // Parse the CSV data into an array of objects
        csvData = parseCSV(data);

        // Calculate min and max values dynamically from the CSV data
        const heights = csvData.map((row) => parseFloat(row['Height (m)']));
        minDataValue = Math.min(...heights);
        maxDataValue = Math.max(...heights);

        // Start button event (moved inside the .then block)
        document.getElementById('startButton').addEventListener('click', () => {
          let index = 0;
          const interval = 2000; // Simulated data update interval (2 seconds)

          function playNextNote() {
            // Use the data to control synth parameters (e.g., pitch and volume)
            const dataValue = parseFloat(csvData[index]['Height (m)']);
            const pitch = mapDataToPitch(dataValue);
            const volume = dataValue;

            // Play a note
            synth.triggerAttackRelease(pitch, '8n', undefined, volume);

            // Move to the next data point
            index = (index + 1) % csvData.length;

            // Schedule the next note
            setTimeout(playNextNote, interval);
          }

          // Start playing
          playNextNote();
        });

        // Stop button event
        document.getElementById('stopButton').addEventListener('click', () => {
          // Stop the music
          synth.releaseAll();
        });
      })
      .catch((error) => {
        console.error("Error fetching CSV data:", error);
      });

    function parseCSV(csv) {
      // Split the CSV into rows
      const rows = csv.trim().split("\n");
      const headers = rows[0].split(",");
      const data = [];

      for (let i = 1; i < rows.length; i++) {
        const row = rows[i].split(",");
        const entry = {};
        for (let j = 0; j < headers.length; j++) {
          entry[headers[j].trim()] = row[j].trim();
        }
        data.push(entry);
      }

      return data;
    }

    // Map "Height (m)" values to musical pitch (adjust the mapping as needed)
    function mapDataToPitch(dataValue) {
      const minPitch = 36; // MIDI note number for C2
      const maxPitch = 60; // MIDI note number for C5
      const pitchRange = maxPitch - minPitch;
      const normalizedValue = (dataValue - minDataValue) / (maxDataValue - minDataValue);
      return Math.round(minPitch + normalizedValue * pitchRange);
    }
  </script>

<script>
  // Initialize the map
  var map = L.map('map').setView([51.478027, -0.193165], 13);

  // Add a tile layer to the map
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);
//const marker = L.marker([51.478027, -0.193165]).addTo(map);
</script>  
</body>
</html>
